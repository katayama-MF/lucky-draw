# リール・スピン・ストップ処理の全体チェック

「基本的な指示のみ再現」「余計な処理がないか」の観点で洗い出した結果です。  
**どうするかはご判断ください。**

---

## 1. あなたの基本指示（再掲）

### ① スタートを押す
- リールは回転し始め、**約3フレームで加速。Max速度は60**
- **当選番号の抽選は行わない**
- **数字順**のときは **1-2-3-4… と数字が増えていく**

### ② ストップを押す
- **当選番号の抽選を行う** → **ログに番号を表示**
- **1フレーム後から減速開始**
- **Max速度は60**で、当選番号付近まで回して、**選択された演出パターン**で当選番号に停止
- **数字順**のときは **当選番号を無理やり割り込ませない**（リールをそこまで回転させるだけ）
- **減速してから演出パターン直前のスピードまで** の時間は **約3秒**

### その他（過去の要望）
- デフォルトは**標準**（サクサクにしない）
- ストップ後に速度表示が1000などにならない
- リールが止まった番号と大きく表示する当選番号を一致させる
- 速度表示60のとき、実速度も60に見える（高リフレッシュレート対応）

---

## 2. 現在入っている処理の一覧

### A. 基本指示に直接対応しているもの（残す想定）

| 処理 | 場所 | 内容 |
|------|------|------|
| スタートで抽選しない | startSpin() | 抽選は stopSpin() 内のみ |
| 3フレーム加速・Max60 | startSpin() | ACCEL_FRAMES=3, SPIN_SPEED=60, move=speed*(dt/FRAME_MS) |
| 数字順で 1-2-3-4 | buildReel() | sequential のとき remainingSlotIndices をシャッフルしない |
| ストップで抽選 | stopSpin() | actualWinnerSlotIdx, winnerIdx を決定しログ表示 |
| 1フレーム後に減速開始 | stopSpin() | requestAnimationFrame(startDecel) で1fr遅延 |
| 減速初速Max60 | stopSpin() | INIT_DECEL_SPEED, coastSpeed を 60 以下に制限 |
| 約3秒で減速 | stopSpin() | DECEL_FRAMES=180（60fps 想定）＋ dt/FRAME_MS で実時間に近づける |
| 数字順で割り込みなし | stopSpin() | isSeq のとき doSwap を呼ばない（コーストで回すだけ） |
| 演出パターンで停止 | runPatternFinale() | 5パターン（Overshoot, Normal, Feint, Pendulum, Direct） |
| 止まった番号＝当選表示 | stopSpin() | 数字順: seqTargetIdx を winnerIdx に合わせる / ランダム: randomCenterIdx にスワップ＋停止位置を一致 |
| 速度表示の上限60 | setReelSpeedDisplay() | 0〜60 でクリップ |
| 実速度が60に見える | animate/coast/decelerate | FRAME_MS と dt で移動量をスケール |

---

### B. 基本指示には書いていないが「仕様としてあるとよさそう」なもの

| 処理 | 場所 | 内容 | 判断のポイント |
|------|------|------|----------------|
| ランダムモード | buildReel(), stopSpin() | シャッフル・useSubset・doSwap | 数字順以外の並びを許すなら残す |
| リール速度の左下表示 | setReelSpeedDisplay(), 各所 | 「速度 60.0」など | デバッグ・体感用。不要なら削除可 |
| スピードライン（速い線） | speedLines, opacity | 回転/減速中に表示 | 演出。不要なら削除可 |
| hot / confirmed の枠演出 | goHot(), finish() | 枠の色・フラッシュ | 演出。不要なら削除可 |
| 当選後の confetti / sparkles | showWinner() | 紙吹雪・キラキラ | 演出。不要なら削除可 |
| SE（効果音） | SE.start, SE.stop, reelTick, confirm, countdown, winner... | 各種音 | 不要なら一括オフ or 削除 |
| BGM | BGM.idle(), BGM.stop(), stopAllEffects() |  BGM制御 | 不要なら削除可 |
| try/catch で stopSpin を保護 | stopSpin() | 例外で state='idle' に戻す | 暴走防止。残すのが無難 |

---

### C. 基本指示に直接は不要で「余計」になりうるもの

| 処理 | 場所 | 内容 | 推奨 |
|------|------|------|------|
| **予測演出（流れ星・ワープ）** | decidePrediction(), startPredictionEffect() | 当選ランクに応じて確率で流れ星 or ワープ演出 | **基本だけなら削除候補**。ストップ直後に startPredictionEffect を呼んでいる |
| **5種類の演出パターン** | runPatternFinale() | Overshoot, Normal, Feint, Pendulum, Direct の5種（Step-by-Step は削除済み） | 指示は「選択された演出パターンに基づいて」なので**1種類（例: Normal）に統一する**選択肢あり |
| **パターンごとのオフセット** | patternOffset (2→+1, 3→+3), randomCenterIdx | Feint で1つ先、Step で3つ先にスワップ | パターンを減らすならここも整理 |
| **減速中のログ** | decelerate() 内 | 「減速中 df=N 速度=X」を約45frごと | デバッグ用。本番では**オフ or 削除**可 |
| **コースト時のログ** | 数字順コースト時 | 「コースト 速度: X (Nfr)」 | 同上 |
| **「減速: 約3秒 → Pattern: ○○」ログ** | stopSpin() | 毎回1行 | デバッグ用。**オフ or 削除**可 |
| **「速度 ストップ時: X → 減速初速: Y」ログ** | stopSpin() | 毎回1行 | 同上 |
| **「🎯 Final approach」ログ** | decelerate() 終了時 | 1行 | 同上 |

---

### D. 未使用・冗長なコード（削除してよい）

| 処理 | 場所 | 内容 |
|------|------|------|
| **decelTotalDist** | stopSpin() | 計算しているが**どこからも参照されていない**。削除可 |
| **coastExtraSpeed** | stopSpin() | 0 にしたまま。シミュレーションで `+ coastExtraSpeed*Math.sin(...)` とあるが常に0なので**実質未使用**。削除可 |
| **lastPattern でパターン被り避け** | stopSpin() | 「前回と違うパターン」にしている。**同じパターン連続を許すなら削除**可 |

---

### E. 定数・フレーム数まわり（仕様の確認）

| 名前 | 値 | 役割 | 判断のポイント |
|------|-----|------|----------------|
| FRAME_MS | 1000/60 | 60fps 基準の dt スケール | リフレッシュレートに依存しない速度用。**基本のままでよい** |
| DECEL_FRAMES | 180 | 減速の「フレーム数」 | 60fps で約3秒。**dt スケール後は実時間は環境依存**。厳密に3秒にしたいなら「経過時間ベース」に変更する必要あり |
| MAX_COAST_FRAMES | 360 | 数字順コーストの上限フレーム | 約6秒上限。**変えたいなら数値だけ変更** |
| ACCEL_FRAMES | 3 | スタート時の加速フレーム数 | 指示どおり |
| SPIN_SPEED / INIT_DECEL_SPEED 上限 | 60 | 最大速度 | 指示どおり |
| T | 3 | 演出の時間スケール（標準固定） | パターン内の setTimeout 等に使用。**固定でよい** |

---

## 3. 削除・簡略化の候補（判断を仰ぎたい点）

1. **予測演出（流れ星・ワープ）**  
   - ストップ時の `decidePrediction` / `startPredictionEffect` を**やめる**か、**残す**か。
2. **演出パターン**  
   - **6種類のまま**か、**1種類（例: Normal だけ）に絞る**か。
3. **ログ**  
   - 「減速: 約3秒 → Pattern: ○○」「速度 ストップ時…」「減速中 df=…」「コースト 速度…」「🎯 Final approach」を**本番では出さない**（削除 or フラグでオフ）にするか。
4. **速度表示（左下の数字）**  
   - **残す**か、**削除**するか。
5. **スピードライン / hot・confirmed / confetti・sparkles / SE・BGM**  
   - どれを**残すか・消すか**。
6. **decelTotalDist・coastExtraSpeed**  
   - **削除してよい**か（推奨は削除）。
7. **lastPattern（パターンかぶり防止）**  
   - **同じパターン連続を許す**なら lastPattern 処理を**削除**してよいか。
8. **減速の「約3秒」**  
   - 現在は「180フレーム × (dt/FRAME_MS)」なので、高リフレッシュレートでは実時間が短くなる。**厳密に3秒**にしたいか、**現状のままでよい**か。

---

## 4. まとめ

- **基本指示に直接対応している部分**は上記のとおりで、意図は満たせている構成です。
- **余計になりうるもの**は主に  
  - 予測演出（流れ星・ワープ）  
  - 6種類の演出パターンとそのログ  
  - デバッグ用ログ  
  - 未使用変数（decelTotalDist, coastExtraSpeed）  
  です。
- **どうするか決めたい点**は「3. 削除・簡略化の候補」の 1〜8 です。  
  ここで「削る」「残す」「1種類に絞る」などを決めてもらえれば、それに合わせて具体的な修正案（どの関数のどの行を消す/変えるか）を出します。
