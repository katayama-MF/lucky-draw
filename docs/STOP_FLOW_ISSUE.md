# ストップ〜演出の流れ：何がおかしいか

## 理想の流れ（ユーザー希望）

1. **ストップ押す**
2. **1秒間のうちに** 当選番号が200個より遠かったら → **200個前のカードにワープ**して **リール回転継続**（まだ減速しない）
3. **1秒後から減速開始**
4. **当選番号に一定数近づいたら** 「演出のための減速」開始
5. **演出**（オーバーシュート／フェイント／ペンデュラムなど）

つまり：
- ワープ後も「しばらく回り続ける」
- 減速は「1秒経ってから」始まる
- 「通常減速」と「演出用の最終アプローチ」の2段階がある
- **演出は「止まったあとの小さい動き」ではなく、「当選に近づきつつ止まる」その過程**

---

## 現状の実装で起きていること

### ① ワープの直後から減速している（1秒の回転継続がない）

- **理想**: 200以上離れていたらワープ → **そのまま回転継続 1秒** → 1秒後から減速開始
- **現状**: 200以上離れていたら **同じフレームでワープ** → **次のフレームからいきなり減速開始**（`requestAnimationFrame(startDecel)`）
- つまり「ストップ押したらすぐ減速」になっており、**「1秒間は回り続ける」が存在しない**。

### ② 減速開始が「1秒後」になっていない

- **理想**: ストップ押下から **1秒後** に減速開始
- **現状**: ストップ押下の **次のフレーム** で `startDecel()` → `decelerate()` が走る
- 「1秒待ってから減速」の処理がどこにもない。

### ③ 「演出のための減速」という区切りがない

- **理想**: まず通常減速 → **当選に一定数近づいたタイミング**で「演出のための減速」に切り替え → その流れで演出
- **現状**: **ずっと同じ減速曲線で** 当選位置まで行き、**完全に止まってから** `runPatternFinale()` で微少移動（オーバーシュート等）
- 「近づいたら演出用減速開始」という**段階切り替え**がなく、演出は「止まったあとのちょっとした動き」だけになっている。

### ④ 演出の前に「当選で完全停止」してしまっている（ここが一番のズレ）

- **理想**: 減速しながら当選に**近づいていく** → あるところで「演出用減速」→ **演出が「当選に寄せて止める」役割**を持つ
- **現状**:
  1. 減速で `p` が 1 になるまで動かす
  2. `p >= 1` のとき **`setPos(targetReelPos)` で当選位置にピタリ止める**
  3. **そのあと** `runPatternFinale(targetReelPos)` で「当選位置を中心にした数ピクセル〜1マス程度の動き」だけ

なので、**演出が始まる時点ではすでに「当選番号でリールが止まった状態」**になっている。

- オーバーシュート → 「止まった状態から少し行き過ぎて戻る」だけ
- フェイント → 「止まった状態から1マス手前に見せて戻す」だけ
- ペンデュラム → 「止まった状態で小さい振動」

**「減速しながら当選に近づく」部分と「演出」が分離しておらず、演出が「止まったあとのおまけ」になっている。**

---

## まとめ：何がおかしいか

| 項目 | 理想 | 現状 |
|------|------|------|
| ワープ後 | 1秒間リール回転継続 | ワープ直後から減速開始 |
| 減速開始 | ストップから1秒後 | ストップの次のフレーム |
| 減速の段階 | 通常減速 → 近づいたら「演出用減速」 | 1本の減速で当選まで一直線 |
| 演出の役割 | 当選に近づきつつ止まる「過程」 | 当選で止まった「後」の微少動きだけ |

**一言でいうと**:  
「ストップ → 1秒は回る → 減速 → 近づいたら演出用減速 → 演出で止まる」ではなく、  
「ストップ → すぐ減速 → 当選で完全停止 → そのあと演出でちょっと動かす」になっている、というのがおかしい点です。

---

## 実装変更後（現在の流れ）

1. **ストップ押す** → 抽選・ワープ判定（200以上離れていればワープ）
2. **1秒間リール回転継続**（`continueSpin`：ワープ後も同じ速度で回り続ける）
3. **1秒経過後から減速開始**（`startDecel` → `decelerate`）
4. **当選に一定数（3マス）まで近づいたら** 演出へ渡す（`setPos(targetReelPos)` は呼ばない。`runPatternFinale(targetReelPos)` のみ）
5. **演出**（オーバーシュート／フェイント等）が現在の `reelPos` から `targetCenter` へ動かして止める
